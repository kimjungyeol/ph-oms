<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="sample/layouts/default-layout">
<th:block layout:fragment="content">
    <div class="container">
        <h2>Simulation</h2>
        <!-- <div class="mt-3" data-trigger="button">
            <a href="javascript:void(0);" class="btn btn-danger"  id="simulationBtn">Save</a> 
        </div> -->
        
        <div class="d-flex justify-content-start" data-trigger="button">
            <div class="btn-group p-1 mr-1" role="group">
                <button class="btn btn-outline-info" id="simulationBtn">
                    <i class="fa fa-th-large"></i>Simulation
                </button>
                <button class="btn btn-outline-info" id="simulationApiBtn">
                    <i class="fa fa-th-large"></i>Simulation API
                </button>
            </div>
        </div>
        
        <div class="mt-3" data-trigger="form">
            <div class="form-floating mb-3">
                <!-- <div>
                    <select class="form-select" id="ftaId" name="ftaId" style="width:500px;">
                        <option value="">협정</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div> -->
                <input class="form-control" id="ftaId" name="ftaId" style="width:500px;">
                <label for="email">협정</label>
            </div>
            <div class="form-floating mb-3">
                <input class="form-control" id="destinationCode" name="destinationCode" style="width:500px;">
                <label for="email">수출</label>
            </div>
            <div class="form-floating mb-3">
                <input class="form-control" id="hscode" name="hscode" style="width:500px;">
                <label for="email">품목코드</label>
            </div>
            <div class="form-floating mb-3">
                <input class="form-control" id="amount" name="amount" style="width:500px;">
                <label for="email">상품가격</label>
            </div>
            <!-- <div class="form-floating mb-3">
                <input class="form-control" id="email" name="email" type="email" style="width:500px;">
                <label for="email">결정기준 1</label>
            </div> -->
            <div class="form-floating mb-3">
                <div>
                    <select class="form-select" id="psrStandard" name="psrStandard" style="width:500px;">
                        <option value="">원산지 결정 기준</option>
                        <option value="CTH">CTH</option>
                        <option value="RVC">RVC</option>
                    </select>
                </div>
            </div>
            <div class="form-floating mb-3" id="rvcStandardRateArea" style="display: none;">
                <input class="form-control" id="rvcStandardRate" name="rvcStandardRate" style="width:500px;">
                <label for="email">RVC 비율</label>
            </div>
        </div>
        
        <div class="mt-2" data-trigger="button">
            <a href="javascript:void(0);" class="btn btn-primary" id="clearRow">Clear Row</a>
            <a href="javascript:void(0);" class="btn btn-primary" id="appendRow">Append Row</a>
            <a href="javascript:void(0);" class="btn btn-primary" id="deleteRow">Delete Row</a>
            <a href="javascript:void(0);" class="btn btn-primary" id="testRow">Test</a>
        </div>
        
        <div class="mt-2" id="materialGrid"></div>
        
        <div class="d-flex justify-content-start" data-trigger="button">
            <div class="btn-group p-1 mr-1" role="group">
                <button class="btn btn-outline-info" id="simulationBtn2">
                    <i class="fa fa-th-large"></i>Simulation
                </button>
                <button class="btn btn-outline-info" id="simulationApiBtn2">
                    <i class="fa fa-th-large"></i>Simulation API
                </button>
            </div>
        </div>
        
        <div id="resultArea" style="display: none;">Fail</div>
    </div>
    
    <script th:inline="javascript">
        'use strict';
    
        // 1.page init area.
        ;(function(co, grid) {
            co.initParams = {
            }
            
            co.uriMap = {
                simulation: '/sample/judgment',
            }
            
            //grid id 지정.
            //grid 갯수만큼 지정 되어야 함.
            grid.id = {
                grid: 'materialGrid',   //<div class="mt-2" id="sampleGrid"></div>
            }
            
            //grid js include.
            co.require(['./grid/grid-material.js']);
            
        })(wg.c, wg.gr);
        
        // 2.function area.
        ;(function(co, fn, trigger, grid) {
            fn.simulation = function() {
            	let formData = fn.form.getData();
            	
                let materialGrid = grid[grid.id.grid].context;
                
                let rowData = materialGrid.getData();
                
                if (rowData.length == 0) {
                	$('#testRow').trigger('click');
                	rowData = materialGrid.getData();
                }                
                
                //grid validation check.
                let v = materialGrid.validate();
                //console.log('v ==> ', v);
                if (v.length > 0) {
                    // TODO swal confirm 창 작업.
                    // error message.
                    return;
                }
                
                let opt = {
                    uri: co.uriMap.simulation,
                    params: { 
                    	formData: formData,
                    	rowData: rowData, 
                	}
                }
                
                fn.api.save(opt, function(res) {
                    console.log('save callback fnc!!');
                    console.log('res', res);
                    
                    let result = res.result;
                    let resultArea = document.getElementById('resultArea');

                    resultArea.style.display = 'block';
                    
                    if (result) {
                    	resultArea.innerText = '성공';
                    } else {
                    	resultArea.innerText = '실패';
                    }
                });
            }
        })(wg.c, wg.f, wg.t, wg.gr);
        
        // 3.event area.
        ;(function(co, fn, trigger, grid) {
            fn.event = function() {
                //wg.t => data-trigger="button" 하위의 id를 가지고 있는 dom이 모두 등록 된다.
                
                //save.
                $(trigger.button.simulationBtn).click(function() {
                    fn.simulation();
                });
                $(trigger.button.simulationBtn2).click(function() {
                    fn.simulation();
                });
                $(trigger.button.simulationApiBtn).click(function() {
                    fn.simulationApi();
                });
                $(trigger.button.simulationApiBtn2).click(function() {
                    fn.simulationApi();
                });
                
                /* === grid event === */
                //clear row
                $(trigger.button.clearRow).click(function() {
                    grid[grid.id.grid].context.clear();
                });
                //append row
                $(trigger.button.appendRow).click(function() {
                    grid[grid.id.grid].context.appendRow();
                });
                //delete row
                $(trigger.button.deleteRow).click(function() {
                    //true : 삭제여부 alert 사용., false : 삭제여부 alert 미사용.
                    grid[grid.id.grid].context.removeCheckedRows(false);  
                });
                //test row
                $(trigger.button.testRow).click(function() {
                    grid[grid.id.grid].context.appendRows(materialList);
                });
            }
            
        })(wg.c, wg.f, wg.t, wg.gr);
    </script>
    <script th:inline="javascript">
        'use strict';
        $(document).ready(() => {
            const co = wg.c;
            const fn = wg.f;
            const grid = wg.gr;
            
            // materialGrid load.
            grid.render(grid.id.grid, co.initParams);
            
            // event load.
            fn.event();
            
            /////////////////////////////////////////////////////////////
            document.getElementById('psrStandard').addEventListener('input', (e) => {
            	let psrVal = e.target.value;
            	
            	console.log('psr change.......................');
            	
            	if (psrVal == 'RVC') {
            		document.getElementById('rvcStandardRateArea').style.display = 'block';
            	} else {
            		document.getElementById('rvcStandardRateArea').style.display = 'none';
            	}
            });
            
            
            ////////////////////////////////////////////////////////////
            fn.form.setData({
            	ftaId: 'fta-test',
            	destinationCode: 'test',
            	hscode: '830140',
            	amount: '100000',
            	psrStandard: 'CTH',
            });
            ////////////////////////////////////////////////////////////
        });
        
        // test Data
        let materialList = [
            {itemName: 'mtr1', hscode: '830140', amount: '50000', origin: 'Y'},
            {itemName: 'mtr2', hscode: '830140', amount: '30000', origin: 'Y'},
            {itemName: 'mtr3', hscode: '830140', amount: '20000', origin: 'N'},
        ]
    </script>    
</th:block>
</html>